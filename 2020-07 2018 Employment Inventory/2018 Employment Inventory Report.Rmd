---
title: "2020-07 Employment Inventory 2018"
author: "Purva Singh & Kelsie Telson"
date: "7/24/2020"
output: html_document
---

The following report contains high-level results from QC testing conducted on the 2018 Employment Inventory dataset. The review was conducted by QA analysts Purva Singh and Kelsie Telson in July 2020. Due to the confidentiality of EDD data, only aggregate information will be displayed here. To see the full Test Plan associated with this report, including select record-level findings, please see "R:\DPOE\Employment\CAEDD\QCEW Microdata\RESTRICTED\2019\QAQC\Office of QA\Test Plan 2018 Employment Inventory.xlsx".

```{r setup, include=FALSE}
pkgTest <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dep = TRUE)
  sapply(pkg, require, character.only = TRUE)}


connect_datawarehouse <- function() {
  
  # Connect to Datahub using RODBC package
  channel <- RODBC::odbcDriverConnect(
    paste0("driver={SQL Server}; server=sql2014b8;
             database=EMPCORE;
             trusted_connection=true"))
  
  # Return open RODBC connection
  return(channel)
}



packages <- c("RODBC","tidyverse","openxlsx","hash","readtext","data.table","dplyr", "knitr")
pkgTest(packages)


# connect to database
channel <- connect_datawarehouse()

#retrieve data from sql server
#note: variables [SHAPE] and [GDB_GEOMATTR_DATA] not included due to memory restrictions
raw_dt <- data.table::as.data.table(
  RODBC::sqlQuery(channel,
                  paste0("
SELECT [OBJECTID]
      ,[Status]
      ,[Score]
      ,[Match_type]
      ,[Match_addr]
      ,[emp_id]
      ,[dba]
      ,[address]
      ,[city]
      ,[zip]
      ,[emp1]
      ,[emp2]
      ,[emp3]
      ,[payroll]
      ,[naics]
      ,[own]
      ,[meei]
      ,[init]
      ,[end_]
      ,[react]
      ,[Run]
      ,[Check_]
      ,[flag]
      ,[Move]
      ,[Comment]
      ,[MGRA13]
  FROM [EMPCORE].[dbo].[CA_EDD_EMP2018]"),
                  stringsAsFactors = FALSE),
  stringsAsFactors = FALSE)


#note: variables [SHAPE] and [GDB_GEOMATTR_DATA] not included due to memory restrictions
raw_dt_hqd <- data.table::as.data.table(
  RODBC::sqlQuery(channel,
                  paste0("SELECT [OBJECTID]
      ,[emp_id]
      ,[sub_emp_id]
      ,[dba]
      ,[Comment]
      ,[Check_]
      ,[share]
      ,[MGRA13]
  FROM [EMPCORE].[dbo].[CA_EDD_EMP2018HQD]"),
                  stringsAsFactors = FALSE),
  stringsAsFactors = FALSE)

```

## Test 1

1c. Check for no NaNs, 0s in dataset
The majority of variables have NAs  across multiple records, however there are no NA values for emp_id or MGRA13. Blake notes the NAs are acceptable as long as they are not in these variables. 

There are 2 records for which [ZIP]= 0. These records should be reviewed by the requesting team.
Additionally, variables [emp1], [emp2], [emp3], and [payroll] display a number of records equal to 0. These cases were investigated in more detail in Test 2.

1d. Check datatypes of each column makes sense
All variable types appear to be appropriate.

```{r test1}
summary(raw_dt)

test1c_na<-as.data.table(raw_dt %>%
  select(everything()) %>%
  summarise_all(funs(sum(is.na(.)))))

test1c_zeros<-rbind(table(raw_dt$zip==0),
      table(raw_dt$emp1==0),
      table(raw_dt$emp2==0),
      table(raw_dt$emp3==0),
      table(raw_dt$payroll==0))
test1c_zeros<- as.data.table(cbind(variable=c("zip", "emp1", "emp2", "emp3", "payroll"),
                                   test1c_zeros))
setnames(test1c_zeros, old = c('FALSE','TRUE'), new = c('Not Zero','Zero'))

kable(test1c_na, caption="Test 1c: Records with NA")

kable(test1c_zeros, caption="Test 1d: Records with 0")

```



## Test 7

7a. Check totals against BLS Quarter 3 2018 (establishments, employees)
 Totals in the SANDAG dataset are slightly lower (~23,000-24,000) for emp1, emp2, and emp3 as compared to BLS. Payroll is approximately $449 million less than BLS. 

7b. Check totals against published annual totals from EDD Organization
"R:\DPOE\Employment\CAEDD\QCEW Microdata\RESTRICTED\2018\SourceData"



```{r test7}
#Test 7
test7a<- as.data.table(cbind(variable=c("emp1","emp2", "emp3", "payroll"),
              rbind(sum(raw_dt$emp1, na.rm=TRUE),
                    sum(raw_dt$emp2, na.rm=TRUE),
                    sum(raw_dt$emp3, na.rm=TRUE),
                    sum(raw_dt$payroll, na.rm=TRUE)),
              bls=c(1458131,1461622,1466234,21848394370))) #values found on bls website, screenshot in project folder

test7a$V2<- as.numeric(test7$V2)
test7a$bls<- as.numeric(test7$bls)
test7a$diff<- test7$V2-test7$bls

kable(test7a, caption="Test 7a: BLS Comparison")

```


